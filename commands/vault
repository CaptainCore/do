# ----------------------------------------------------
#  Performs a full site backup to a Restic repository on B2.
#  Credentials can be injected via environment variables or piped via stdin.
# ----------------------------------------------------
function run_vault() {
    echo "ðŸš€ Starting secure snapshot to Restic B2 repository..."

    # --- Pre-flight Checks ---
    if ! setup_restic; then return 1; fi
    if ! setup_wp_cli; then return 1; fi
    if ! command -v zip &>/dev/null; then echo "âŒ Error: The 'zip' command is required for this operation." >&2; return 1; fi
    if ! "$WP_CLI_CMD" core is-installed --quiet; then
        echo "âŒ Error: This does not appear to be a WordPress installation." >&2
        return 1
    fi

    # --- Read Credentials ---
    local b2_bucket b2_path b2_key_id b2_app_key restic_password
    
    # MODE 1: Check for pre-existing environment variables first.
    if [ -n "$B2_ACCOUNT_ID" ]; then
        echo "   - Found credentials in environment variables."
        b2_bucket="$B2_BUCKET"
        b2_path="$B2_PATH"
        b2_key_id="$B2_ACCOUNT_ID"
        b2_app_key="$B2_ACCOUNT_KEY"
        restic_password="$RESTIC_PASSWORD"
    else
    # MODE 2: Fall back to reading from stdin.
        if [ -t 0 ]; then # Check if stdin is a terminal (i.e., not a pipe)
            echo "âŒ Error: This command requires credentials." >&2
            echo "   Please either pipe them via stdin OR set them as environment variables." >&2
            echo "   Usage: cat /path/to/secrets.txt | _do vault" >&2
            return 1
        fi
        echo "   - Reading credentials from standard input..."
        read -r b2_bucket
        read -r b2_path
        read -r b2_key_id
        read -r b2_app_key
        read -r restic_password
    fi

    # Universal validation for both methods.
    if [ -z "$b2_bucket" ] || [ -z "$b2_path" ] || [ -z "$b2_key_id" ] || [ -z "$b2_app_key" ] || [ -z "$restic_password" ]; then
        echo "âŒ Error: One or more required credentials were not found or were empty." >&2
        return 1
    fi

    # --- Set Environment Variables for Restic B2 Backend ---
    export B2_ACCOUNT_ID="$b2_key_id"
    export B2_ACCOUNT_KEY="$b2_app_key"
    local restic_repo="b2:${b2_bucket}:${b2_path}"

    # --- Check/Initialize Restic Repository ---
    echo "   - Checking for repository at b2:${b2_bucket}:${b2_path}..."
    if ! "$RESTIC_CMD" --repo "$restic_repo" --password-command="echo \"$restic_password\"" stats >/dev/null 2>&1; then
        echo "   - Repository not found or is invalid. Attempting to initialize..."
        if ! "$RESTIC_CMD" --repo "$restic_repo" --password-command="echo \"$restic_password\"" init; then
            echo "âŒ Error: Failed to initialize Restic repository." >&2
            return 1
        fi
        echo "   - âœ… Repository initialized successfully."
    else
        echo "   - âœ… Repository found."
    fi

    # --- Create Local DB Dump ---
    local wp_root_dir; wp_root_dir=$(realpath ".")
    local site_slug; site_slug=$(basename "$wp_root_dir")
    local random_token; random_token=$(head /dev/urandom | LC_ALL=C tr -dc 'a-zA-Z0-9' | head -c 7)
    local db_filename_base="${site_slug}-db-dump-${random_token}"
    local sql_file_path="${wp_root_dir}/${db_filename_base}.sql"
    local zip_file_path="${wp_root_dir}/${db_filename_base}.zip"

    echo "   - Generating temporary database dump: $(basename "$sql_file_path")"
    if ! "$WP_CLI_CMD" db export "$sql_file_path" --add-drop-table > /dev/null; then
        echo "âŒ Error: Database export failed." >&2
        return 1
    fi
    
    echo "   - Compressing database dump to zip format..."
    if ! zip -q -j "$zip_file_path" "$sql_file_path"; then
        echo "âŒ Error: Failed to zip the database dump." >&2
        rm -f "$sql_file_path"
        return 1
    fi
    
    rm -f "$sql_file_path"

    # --- Run Restic Backup ---
    local original_dir; original_dir=$(pwd)
    echo "   - Changing to WordPress root ($wp_root_dir) for clean snapshot paths..."
    cd "$wp_root_dir" || { echo "âŒ Error: Could not change to WordPress root directory."; rm -f "$zip_file_path"; return 1; }

    echo "   - Backing up current directory (.), which now includes the zipped database dump..."
    if ! "$RESTIC_CMD" --repo "$restic_repo" --password-command="echo \"$restic_password\"" backup --verbose --tag "$site_slug" --tag "wordpress" "."; then
        echo "âŒ Error: Restic backup command failed." >&2
        rm -f "$zip_file_path"
        cd "$original_dir"
        return 1
    fi
    
    # --- Cleanup ---
    cd "$original_dir"
    echo "   - Cleaning up temporary database dump..."
    rm -f "$zip_file_path"

    # Unset B2 variables for security
    unset B2_ACCOUNT_ID B2_ACCOUNT_KEY

    echo "âœ… Vault snapshot complete!"
}